# =============================================================================
# QUAC 100 PQC TLS - Nginx Configuration Example
# =============================================================================
#
# This configuration enables post-quantum TLS termination using the QUAC 100
# hardware accelerator. Supports ML-KEM key exchange and ML-DSA authentication.
#
# Requirements:
#   - Nginx compiled with ngx_http_quac_module
#   - QUAC TLS library installed
#   - ML-DSA certificates (generate with quac_tls_generate_self_signed_mldsa)
#
# Usage:
#   nginx -c /path/to/nginx-pqc.conf
#
# Copyright 2025 Dyber, Inc. All Rights Reserved.
# =============================================================================

# Worker processes (set to number of CPU cores)
worker_processes auto;
worker_rlimit_nofile 65535;

error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 16384;
    use epoll;
    multi_accept on;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # Logging format with PQC info
    log_format pqc_main '$remote_addr - $remote_user [$time_local] "$request" '
                        '$status $body_bytes_sent "$http_referer" '
                        '"$http_user_agent" '
                        'kex=$sent_http_x_pqc_kex cipher=$sent_http_x_pqc_cipher '
                        'rt=$request_time';

    access_log /var/log/nginx/access.log pqc_main;

    # Performance settings
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    keepalive_requests 10000;

    # Buffer settings
    client_body_buffer_size 16k;
    client_header_buffer_size 1k;
    large_client_header_buffers 4 16k;
    client_max_body_size 10m;

    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml application/json application/javascript 
               application/xml application/rss+xml application/atom+xml image/svg+xml;

    # ==========================================================================
    # QUAC PQC TLS Server - Primary (Port 443)
    # ==========================================================================
    server {
        listen 443 ssl http2;
        listen [::]:443 ssl http2;
        server_name pqc.example.com;

        # =======================================================================
        # QUAC PQC TLS Configuration
        # =======================================================================
        
        # Enable QUAC TLS module
        quac_tls on;

        # ML-DSA Certificate and Key
        quac_tls_certificate /etc/nginx/ssl/mldsa65-cert.pem;
        quac_tls_certificate_key /etc/nginx/ssl/mldsa65-key.pem;

        # CA Certificate for client verification (optional)
        # quac_tls_ca_certificate /etc/nginx/ssl/ca-cert.pem;

        # TLS Protocol Version
        quac_tls_protocols TLSv1.3;

        # Key Exchange Algorithms (in preference order)
        # Hybrid modes combine classical and PQC for defense in depth
        quac_tls_kex X25519_ML_KEM_768 P256_ML_KEM_768 ML_KEM_768 X25519;

        # Signature Algorithms (in preference order)
        quac_tls_sigalgs ML_DSA_65 ML_DSA_87 ECDSA_P256 ED25519;

        # Session Management
        quac_tls_session_tickets on;
        quac_tls_session_timeout 300;

        # OCSP Stapling
        quac_tls_ocsp_stapling on;

        # Hardware Acceleration
        quac_tls_hardware on;
        quac_tls_hardware_slot 0;

        # ALPN protocols
        quac_tls_alpn "h2,http/1.1";

        # Client certificate verification (optional)
        # quac_tls_verify_client on;
        # quac_tls_verify_depth 4;

        # =======================================================================
        # Security Headers
        # =======================================================================
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;

        # =======================================================================
        # Application
        # =======================================================================
        root /var/www/html;
        index index.html index.htm;

        location / {
            try_files $uri $uri/ =404;
        }

        # API proxy example
        location /api/ {
            proxy_pass http://backend_servers;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Pass PQC info to backend
            proxy_set_header X-PQC-KEX $sent_http_x_pqc_kex;
            proxy_set_header X-PQC-Cipher $sent_http_x_pqc_cipher;
        }

        # Health check endpoint
        location /health {
            access_log off;
            return 200 "OK\n";
            add_header Content-Type text/plain;
        }

        # PQC status endpoint
        location /pqc-status {
            access_log off;
            return 200 '{"pqc_enabled": true, "hardware": true}';
            add_header Content-Type application/json;
        }
    }

    # ==========================================================================
    # QUAC PQC TLS Server - High Security (Port 8443)
    # ==========================================================================
    server {
        listen 8443 ssl http2;
        listen [::]:8443 ssl http2;
        server_name secure.example.com;

        # Enable QUAC TLS with highest security settings
        quac_tls on;

        # ML-DSA-87 for maximum security
        quac_tls_certificate /etc/nginx/ssl/mldsa87-cert.pem;
        quac_tls_certificate_key /etc/nginx/ssl/mldsa87-key.pem;

        quac_tls_protocols TLSv1.3;

        # ML-KEM-1024 for highest quantum resistance
        quac_tls_kex P384_ML_KEM_1024 ML_KEM_1024;
        quac_tls_sigalgs ML_DSA_87;

        quac_tls_session_tickets on;
        quac_tls_hardware on;

        # Mutual TLS (mTLS) required
        quac_tls_ca_certificate /etc/nginx/ssl/client-ca.pem;
        quac_tls_verify_client on;
        quac_tls_verify_depth 2;

        root /var/www/secure;

        location / {
            # Only allow authenticated clients
            if ($ssl_client_verify != SUCCESS) {
                return 403;
            }
            try_files $uri $uri/ =404;
        }
    }

    # ==========================================================================
    # HTTP to HTTPS Redirect
    # ==========================================================================
    server {
        listen 80;
        listen [::]:80;
        server_name pqc.example.com secure.example.com;

        location / {
            return 301 https://$host$request_uri;
        }

        # Allow Let's Encrypt challenges
        location /.well-known/acme-challenge/ {
            root /var/www/acme;
        }
    }

    # ==========================================================================
    # Backend Upstream
    # ==========================================================================
    upstream backend_servers {
        least_conn;
        keepalive 32;

        server 10.0.0.10:8080 weight=5;
        server 10.0.0.11:8080 weight=5;
        server 10.0.0.12:8080 weight=5 backup;
    }

    # ==========================================================================
    # Status and Metrics
    # ==========================================================================
    server {
        listen 127.0.0.1:8080;
        server_name localhost;

        location /nginx_status {
            stub_status on;
            access_log off;
            allow 127.0.0.1;
            deny all;
        }

        location /metrics {
            # Prometheus metrics endpoint (requires nginx-prometheus-exporter)
            proxy_pass http://127.0.0.1:9113/metrics;
        }
    }
}