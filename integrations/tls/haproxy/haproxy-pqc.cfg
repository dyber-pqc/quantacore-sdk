# =============================================================================
# QUAC 100 PQC TLS - HAProxy Configuration Example
# =============================================================================
#
# This configuration enables post-quantum TLS termination using the QUAC 100
# hardware accelerator with HAProxy. Supports ML-KEM key exchange and ML-DSA
# authentication via OpenSSL engine integration.
#
# Requirements:
#   - HAProxy 2.8+ compiled with OpenSSL 3.x
#   - QUAC OpenSSL engine installed
#   - ML-DSA certificates
#
# Usage:
#   haproxy -f haproxy-pqc.cfg
#
# Copyright 2025 Dyber, Inc. All Rights Reserved.
# =============================================================================

global
    # Daemon settings
    daemon
    maxconn 100000
    nbthread 8
    
    # Logging
    log /dev/log local0
    log /dev/log local1 notice
    
    # Stats socket for runtime management
    stats socket /var/run/haproxy.sock mode 660 level admin
    stats timeout 30s
    
    # SSL/TLS settings
    ssl-default-bind-ciphers TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256
    ssl-default-bind-ciphersuites TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256
    ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets
    ssl-default-server-ciphers TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256
    
    # QUAC OpenSSL Engine Configuration
    # Load the QUAC PQC engine for hardware acceleration
    ssl-engine quac_pqc
    
    # TLS 1.3 groups including PQC hybrids
    # Format: classical:pqc_hybrid:pqc_pure
    ssl-default-bind-curves X25519:x25519_kyber768:kyber768:P-256:p256_kyber768:P-384:p384_kyber1024
    
    # Tune SSL settings for high performance
    tune.ssl.default-dh-param 2048
    tune.ssl.cachesize 100000
    tune.ssl.lifetime 300
    tune.ssl.maxrecord 16384
    tune.ssl.ssl-ctx-cache-size 1000
    
    # Memory settings
    tune.bufsize 32768
    tune.maxrewrite 8192

defaults
    log global
    mode http
    option httplog
    option dontlognull
    option http-server-close
    option forwardfor except 127.0.0.0/8
    option redispatch
    retries 3
    
    timeout connect 5s
    timeout client 30s
    timeout server 30s
    timeout http-request 10s
    timeout http-keep-alive 10s
    timeout queue 30s
    timeout tunnel 1h
    
    # Error files
    errorfile 400 /etc/haproxy/errors/400.http
    errorfile 403 /etc/haproxy/errors/403.http
    errorfile 408 /etc/haproxy/errors/408.http
    errorfile 500 /etc/haproxy/errors/500.http
    errorfile 502 /etc/haproxy/errors/502.http
    errorfile 503 /etc/haproxy/errors/503.http
    errorfile 504 /etc/haproxy/errors/504.http

# =============================================================================
# Frontend: HTTPS with PQC TLS (Port 443)
# =============================================================================
frontend https_pqc
    bind *:443 ssl crt /etc/haproxy/certs/pqc-bundle.pem alpn h2,http/1.1
    
    # Additional SSL options for PQC
    # Note: HAProxy uses OpenSSL's group configuration
    # The QUAC engine provides hardware acceleration for ML-KEM/ML-DSA
    
    # HTTP/2 settings
    http-request set-header X-Forwarded-Proto https
    http-request set-header X-Real-IP %[src]
    http-request set-header X-Forwarded-For %[src]
    
    # Add PQC information headers
    http-response set-header X-PQC-Enabled true
    http-response set-header X-PQC-Engine QUAC-100
    
    # Security headers
    http-response set-header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    http-response set-header X-Content-Type-Options nosniff
    http-response set-header X-Frame-Options SAMEORIGIN
    http-response set-header X-XSS-Protection "1; mode=block"
    
    # ACL definitions
    acl is_api path_beg /api/
    acl is_websocket hdr(Upgrade) -i websocket
    acl is_health path /health
    acl is_metrics path /metrics
    
    # Rate limiting
    stick-table type ip size 100k expire 30s store http_req_rate(10s)
    http-request track-sc0 src
    http-request deny deny_status 429 if { sc_http_req_rate(0) gt 100 }
    
    # Backend selection
    use_backend be_health if is_health
    use_backend be_metrics if is_metrics
    use_backend be_api if is_api
    use_backend be_websocket if is_websocket
    default_backend be_web

# =============================================================================
# Frontend: HTTPS High Security (Port 8443)
# =============================================================================
frontend https_high_security
    bind *:8443 ssl crt /etc/haproxy/certs/mldsa87-bundle.pem verify required ca-file /etc/haproxy/certs/client-ca.pem alpn h2,http/1.1
    
    # Mutual TLS required
    http-request deny unless { ssl_c_used }
    http-request deny unless { ssl_c_verify 0 }
    
    # Pass client certificate info to backend
    http-request set-header X-SSL-Client-CN %[ssl_c_s_dn(cn)]
    http-request set-header X-SSL-Client-Serial %[ssl_c_serial,hex]
    http-request set-header X-SSL-Client-Verify %[ssl_c_verify]
    
    default_backend be_secure

# =============================================================================
# Frontend: HTTP to HTTPS Redirect
# =============================================================================
frontend http_redirect
    bind *:80
    
    # Allow ACME challenges
    acl is_acme path_beg /.well-known/acme-challenge/
    use_backend be_acme if is_acme
    
    # Redirect all other traffic to HTTPS
    http-request redirect scheme https unless is_acme

# =============================================================================
# Backend: Web Application
# =============================================================================
backend be_web
    balance roundrobin
    option httpchk GET /health HTTP/1.1\r\nHost:\ localhost
    
    http-request set-header X-Backend web
    
    server web1 10.0.1.10:8080 check weight 100 inter 3s fall 3 rise 2
    server web2 10.0.1.11:8080 check weight 100 inter 3s fall 3 rise 2
    server web3 10.0.1.12:8080 check weight 100 inter 3s fall 3 rise 2 backup

# =============================================================================
# Backend: API Services
# =============================================================================
backend be_api
    balance leastconn
    option httpchk GET /api/health HTTP/1.1\r\nHost:\ localhost
    
    http-request set-header X-Backend api
    
    # Connection pooling
    http-reuse safe
    
    server api1 10.0.2.10:8080 check weight 100 maxconn 1000
    server api2 10.0.2.11:8080 check weight 100 maxconn 1000
    server api3 10.0.2.12:8080 check weight 100 maxconn 1000

# =============================================================================
# Backend: WebSocket
# =============================================================================
backend be_websocket
    balance source
    option http-server-close
    
    timeout tunnel 1h
    timeout server 1h
    
    server ws1 10.0.3.10:8080 check
    server ws2 10.0.3.11:8080 check

# =============================================================================
# Backend: Secure Services (mTLS only)
# =============================================================================
backend be_secure
    balance roundrobin
    option httpchk GET /health HTTP/1.1\r\nHost:\ localhost
    
    # Re-encrypt to backend with PQC
    server secure1 10.0.4.10:8443 ssl verify required ca-file /etc/haproxy/certs/backend-ca.pem check
    server secure2 10.0.4.11:8443 ssl verify required ca-file /etc/haproxy/certs/backend-ca.pem check

# =============================================================================
# Backend: Health Check
# =============================================================================
backend be_health
    http-request return status 200 content-type text/plain string "OK\n"

# =============================================================================
# Backend: Metrics
# =============================================================================
backend be_metrics
    http-request return status 200 content-type application/json string "{\"status\":\"ok\",\"pqc\":true}"

# =============================================================================
# Backend: ACME Challenges
# =============================================================================
backend be_acme
    server acme 127.0.0.1:8888

# =============================================================================
# Stats Interface
# =============================================================================
listen stats
    bind 127.0.0.1:8404
    mode http
    stats enable
    stats hide-version
    stats uri /stats
    stats refresh 5s
    stats admin if LOCALHOST
    
    # PQC stats endpoint
    http-request return status 200 content-type application/json string "{\"engine\":\"quac_pqc\",\"version\":\"1.0.0\",\"hardware\":true}" if { path /pqc-stats }

# =============================================================================
# Peer Configuration (for session sharing)
# =============================================================================
peers haproxy_peers
    peer haproxy1 10.0.0.1:1024
    peer haproxy2 10.0.0.2:1024
    peer haproxy3 10.0.0.3:1024

# =============================================================================
# SSL Certificate Bundle Format
# =============================================================================
# The PQC certificate bundle should be created as follows:
#
# cat mldsa65-cert.pem mldsa65-key.pem intermediate-ca.pem > pqc-bundle.pem
#
# For hybrid certificates (classical + PQC):
# cat ecdsa-cert.pem mldsa65-cert.pem ecdsa-key.pem mldsa65-key.pem > hybrid-bundle.pem
#
# =============================================================================